<!doctype html>
<html lang="ar">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Ù‡ÙŠÙƒÙ„ ØªÙ†Ø¸ÙŠÙ…ÙŠ - Ù…Ù†Ø´Ø¦ Ù…Ù† Ù…Ù„Ù Excel</title>
  <style>
    :root{font-family: 'Segoe UI', Tahoma, Arial, sans-serif}
    body{direction: rtl; text-align: right; padding:20px; background:#f7f9fc}
    h1{font-size:1.4rem; margin-bottom:10px}
    .controls{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    input[type=file]{padding:6px}
    .search{padding:6px 10px;border-radius:6px;border:1px solid #ccc;width:220px}
    #chart{margin-top:20px}
    ul.org{list-style:none;padding-left:0}
    ul.org ul{margin-right:18px;border-right:1px dashed #ddd;padding-right:12px;margin-top:8px}
    li.node{margin:6px 0;padding:6px 8px;border-radius:8px;background:#fff;box-shadow:0 1px 2px rgba(0,0,0,0.04);cursor:default}
    .node .meta{font-size:0.85rem;color:#555}
    .node .extra{font-size:0.8rem;color:#444;margin-top:6px;line-height:1.4}
    .toggle{margin-left:8px;cursor:pointer;font-weight:bold}
    .hidden{display:none}
    .highlight{background:linear-gradient(90deg,#fff6c2,#fff);border:1px solid #ffd966}
    .info{margin-top:10px;color:#333;font-size:0.95rem}
    .footer{margin-top:18px;color:#666;font-size:0.85rem}
    button{padding:8px 10px;border-radius:6px;border:1px solid #2b6cb0;background:#3182ce;color:white;cursor:pointer}
    .small{font-size:0.85rem;padding:6px 8px}
    .detail-line{margin-bottom:2px}
  </style>
</head>
<body>
  <h1>Ù…ÙˆÙ„Ø¯ Ù‡ÙŠÙƒÙ„ ØªÙ†Ø¸ÙŠÙ…ÙŠ Ù…Ù† Ù…Ù„Ù Excel</h1>
  <div class="controls">
    <label for="file">Ø§Ø±ÙØ¹ Ù…Ù„Ù Excel (.xlsx):</label>
    <input id="file" type="file" accept=".xlsx,.xls" />
    <button id="build" class="small">Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù‡ÙŠÙƒÙ„</button>
    <input id="search" class="search" placeholder="ğŸ” Ø¨Ø­Ø« Ø°ÙƒÙŠ (Ø§Ø³Ù…ØŒ Ù…Ø³Ù…Ù‰ØŒ Ù‚Ø³Ù…ØŒ Ù…ÙˆÙ‚Ø¹...)" />
    <button id="expandAll" class="small">ØªÙˆØ³ÙŠØ¹ Ø§Ù„ÙƒÙ„</button>
    <button id="collapseAll" class="small">Ø·ÙŠ Ø§Ù„ÙƒÙ„</button>
  </div>

  <div class="info">Ù…Ù„Ø§Ø­Ø¸Ø©: ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ­ØªÙˆÙŠ Ø§Ù„ÙˆØ±Ù‚Ø© (sheet) Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„ØªØ§Ù„ÙŠØ©: <strong>Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ÙˆØ¸ÙŠÙÙŠ, Ø§Ù„Ø§Ø³Ù… ÙƒØ§Ù…Ù„Ø§Ù‹ Ø¨Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©, Ø§Ù„Ù…Ø³Ù…Ù‰ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ, Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø¨Ø§Ø´Ø±, Ø§Ù„Ø¬Ù†Ø³ÙŠØ©, Ø§Ù„Ø¬Ù†Ø³, Ø§Ù„Ù‚Ø³Ù…, Ø§Ù„Ù…ÙˆÙ‚Ø¹, ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù…, Ø³Ù†ÙˆØ§Øª Ø®Ø¨Ø±Ø© Ø§Ù„Ø¹Ù…Ù„, Ø§Ù„Ø±Ø§ØªØ¨ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ</strong>. Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ø£Ø®Ø±Ù‰ Ù…Ø«Ù„ Ø§Ù„Ø¨Ø¯Ù„Ø§Øª ÙˆØ§Ù„Ø±Ø§ØªØ¨ Ø§Ù„ÙƒØ§Ù…Ù„ Ø³ØªØ¹Ø±Ø¶ Ø£ÙŠØ¶Ø§Ù‹ Ø¥Ù† ÙˆØ¬Ø¯Øª.</div>

  <div id="chart"></div>
  <div class="footer">Ù…Ù„Ù Ù…ÙØ¹Ø¯ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ â€” Ø§ÙØªØ­ Ø§Ù„Ù…Ù„ÙØŒ Ø§Ø±ÙØ¹ Ø§Ù„Ø¥ÙƒØ³ÙŠÙ„ØŒ Ø«Ù… Ø§Ø¶ØºØ· "Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù‡ÙŠÙƒÙ„". ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¨Ø­Ø« Ø£Ùˆ Ø·ÙŠ/ØªÙˆØ³ÙŠØ¹ Ø§Ù„Ø¹Ù†Ø§ØµØ±.</div>

  <!-- SheetJS for reading Excel in browser -->
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
  <script>
    function sanitizeName(s){ if(s===undefined || s===null) return ''; return String(s).trim(); }

    function buildTree(rows){
      const byName = new Map();
      const nodes = [];
      rows.forEach(r=>{
        const empId = sanitizeName(r['Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ÙˆØ¸ÙŠÙÙŠ']);
        const name = sanitizeName(r['Ø§Ù„Ø§Ø³Ù… ÙƒØ§Ù…Ù„Ø§Ù‹ Ø¨Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©'] || r['Ø§Ù„Ø§Ø³Ù…']);
        const title = sanitizeName(r['Ø§Ù„Ù…Ø³Ù…Ù‰ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ'] || '');
        const mgr = sanitizeName(r['Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø¨Ø§Ø´Ø±'] || '');
        const nationality = sanitizeName(r['Ø§Ù„Ø¬Ù†Ø³ÙŠØ©']);
        const gender = sanitizeName(r['Ø§Ù„Ø¬Ù†Ø³']);
        const dept = sanitizeName(r['Ø§Ù„Ù‚Ø³Ù…']);
        const site = sanitizeName(r['Ø§Ù„Ù…ÙˆÙ‚Ø¹']);
        const joinDate = sanitizeName(r['ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù…']);
        const exp = sanitizeName(r['Ø³Ù†ÙˆØ§Øª Ø®Ø¨Ø±Ø© Ø§Ù„Ø¹Ù…Ù„']);
        const baseSalary = sanitizeName(r['Ø§Ù„Ø±Ø§ØªØ¨ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ']);
        const totalSalary = sanitizeName(r['ÙƒØ§Ù…Ù„ Ø§Ù„Ø±Ø§ØªØ¨']);

        if(!name) return;
        const node = {id: empId||name, name, title, manager: mgr, nationality, gender, dept, site, joinDate, exp, baseSalary, totalSalary, children: []};
        nodes.push(node);
        byName.set(name, node);
      });

      const roots = [];
      nodes.forEach(n=>{
        const mgr = n.manager;
        if(!mgr || /^-+$/.test(mgr) || /^Ù€+$/.test(mgr) || mgr.toLowerCase().includes('null') || mgr.includes('(Ù…Ø³Ø¤ÙˆÙ„ Ù…ÙÙ‚ÙˆØ¯)')){
          roots.push(n);
        } else {
          const parent = byName.get(mgr);
          if(parent){ parent.children.push(n); }
          else {
            const placeholderId = 'mgr::'+mgr;
            if(!byName.has(mgr)){
              const ph = {id: placeholderId, name: mgr, title: '(Ù…Ø³Ø¤ÙˆÙ„ Ù…ÙÙ‚ÙˆØ¯)', children: []};
              byName.set(mgr, ph);
              roots.push(ph);
            }
            byName.get(mgr).children.push(n);
          }
        }
      });
      return roots;
    }

    function createNodeElement(node){
      const li = document.createElement('li');
      li.className = 'node';
      const hasChildren = node.children && node.children.length>0;

      const titleLine = document.createElement('div');
      titleLine.style.display='flex';
      titleLine.style.alignItems='center';

      const toggle = document.createElement('span');
      toggle.className='toggle';
      toggle.textContent = hasChildren ? 'â–¾' : '';

      let ul = null;
      if(hasChildren){
        ul = document.createElement('ul');
        ul.className='org';
        node.children.sort((a,b)=> a.name.localeCompare(b.name,'ar')).forEach(child=>{
          ul.appendChild(createNodeElement(child));
        });
        toggle.onclick = (e)=>{
          e.stopPropagation();
          if(!ul) return;
          ul.classList.toggle('hidden');
          toggle.textContent = ul.classList.contains('hidden') ? 'â–¸' : 'â–¾';
        };
      }

      const nameSpan = document.createElement('span');
      nameSpan.innerHTML = `<strong>${escapeHtml(node.name)}</strong>`;
      nameSpan.style.marginRight='8px';
      const titleSpan = document.createElement('span');
      titleSpan.className='meta';
      titleSpan.textContent = node.title ? ' - '+node.title : '';

      titleLine.appendChild(toggle);
      titleLine.appendChild(nameSpan);
      titleLine.appendChild(titleSpan);
      li.appendChild(titleLine);

      const extra = document.createElement('div');
      extra.className='extra';
      extra.innerHTML = `
        <div class="detail-line">ğŸ‘” Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø¨Ø§Ø´Ø±: ${escapeHtml(node.manager || '')}</div>
        <div class="detail-line">ğŸŒ Ø§Ù„Ø¬Ù†Ø³ÙŠØ©: ${escapeHtml(node.nationality || '')}</div>
        <div class="detail-line">ğŸ‘¤ Ø§Ù„Ø¬Ù†Ø³: ${escapeHtml(node.gender || '')}</div>
        <div class="detail-line">ğŸ¢ Ø§Ù„Ù‚Ø³Ù…: ${escapeHtml(node.dept || '')}</div>
        <div class="detail-line">ğŸ“ Ø§Ù„Ù…ÙˆÙ‚Ø¹: ${escapeHtml(node.site || '')}</div>
        <div class="detail-line">ğŸ“… ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù…: ${escapeHtml(node.joinDate || '')}</div>
        <div class="detail-line">â³ Ø³Ù†ÙˆØ§Øª Ø§Ù„Ø®Ø¨Ø±Ø©: ${escapeHtml(node.exp || '')}</div>
        <div class="detail-line">ğŸ’° Ø§Ù„Ø±Ø§ØªØ¨ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ: ${escapeHtml(node.baseSalary || '')}</div>
        ${node.totalSalary ? `<div class="detail-line">ğŸ’µ ÙƒØ§Ù…Ù„ Ø§Ù„Ø±Ø§ØªØ¨: ${escapeHtml(node.totalSalary)}</div>` : ''}
      `;
      li.appendChild(extra);

      if(ul){ li.appendChild(ul); }
      return li;
    }

    function renderTree(roots, container){
      container.innerHTML='';
      const ul = document.createElement('ul');
      ul.className='org';
      roots.sort((a,b)=> a.name.localeCompare(b.name,'ar')).forEach(r=>{
        ul.appendChild(createNodeElement(r));
      });
      container.appendChild(ul);
    }

    function escapeHtml(text){ return String(text).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

    let parsedRows = null;
    document.getElementById('file').addEventListener('change', (evt)=>{
      const f = evt.target.files[0];
      if(!f) return;
      const reader = new FileReader();
      reader.onload = function(e){
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, {type:'array'});
        const firstSheetName = workbook.SheetNames[0];
        const ws = workbook.Sheets[firstSheetName];
        const rows = XLSX.utils.sheet_to_json(ws, {defval:''});
        parsedRows = rows;
        document.getElementById('chart').innerHTML = `<div style="padding:10px;background:#fff;border-radius:8px;">ØªÙ… Ù‚Ø±Ø§Ø¡Ø© ${rows.length} ØµÙÙˆÙ Ù…Ù† Ø§Ù„ÙˆØ±Ù‚Ø©: <strong>${firstSheetName}</strong>. Ø§Ø¶ØºØ· "Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù‡ÙŠÙƒÙ„" Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø´Ø¬Ø±Ø©.</div>`;
      };
      reader.readAsArrayBuffer(f);
    });

    document.getElementById('build').addEventListener('click', ()=>{
      const container = document.getElementById('chart');
      if(!parsedRows){ container.innerHTML = '<div style="color:#b00">Ù„Ù… ÙŠØªÙ… Ø±ÙØ¹ Ù…Ù„Ù Ø¨Ø¹Ø¯.</div>'; return; }
      const normalized = parsedRows.map(r=>({
        'Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ÙˆØ¸ÙŠÙÙŠ': r['Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ÙˆØ¸ÙŠÙÙŠ'] || r['ID'] || '',
        'Ø§Ù„Ø§Ø³Ù… ÙƒØ§Ù…Ù„Ø§Ù‹ Ø¨Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©': r['Ø§Ù„Ø§Ø³Ù… ÙƒØ§Ù…Ù„Ø§Ù‹ Ø¨Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©'] || r['Name'] || '',
        'Ø§Ù„Ù…Ø³Ù…Ù‰ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ': r['Ø§Ù„Ù…Ø³Ù…Ù‰ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ'] || r['Job Title'] || '',
        'Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø¨Ø§Ø´Ø±': r['Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø¨Ø§Ø´Ø±'] || r['Manager'] || '',
        'Ø§Ù„Ø¬Ù†Ø³ÙŠØ©': r['Ø§Ù„Ø¬Ù†Ø³ÙŠØ©'] || '',
        'Ø§Ù„Ø¬Ù†Ø³': r['Ø§Ù„Ø¬Ù†Ø³'] || '',
        'Ø§Ù„Ù‚Ø³Ù…': r['Ø§Ù„Ù‚Ø³Ù…'] || '',
        'Ø§Ù„Ù…ÙˆÙ‚Ø¹': r['Ø§Ù„Ù…ÙˆÙ‚Ø¹'] || '',
        'ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù…': r['ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù…'] || '',
        'Ø³Ù†ÙˆØ§Øª Ø®Ø¨Ø±Ø© Ø§Ù„Ø¹Ù…Ù„': r['Ø³Ù†ÙˆØ§Øª Ø®Ø¨Ø±Ø© Ø§Ù„Ø¹Ù…Ù„'] || '',
        'Ø§Ù„Ø±Ø§ØªØ¨ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ': r['Ø§Ù„Ø±Ø§ØªØ¨ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ'] || '',
        'ÙƒØ§Ù…Ù„ Ø§Ù„Ø±Ø§ØªØ¨': r['ÙƒØ§Ù…Ù„ Ø§Ù„Ø±Ø§ØªØ¨'] || ''
      }));
      const roots = buildTree(normalized);
      renderTree(roots, container);
    });

    document.getElementById('search').addEventListener('input', (e)=>{
      const q = e.target.value.trim().toLowerCase();
      if(!q){
        document.querySelectorAll('.highlight').forEach(el=>el.classList.remove('highlight'));
        return;
      }
      const nodes = Array.from(document.querySelectorAll('.node'));
      nodes.forEach(n=>{
        n.classList.remove('highlight');
        const text = (n.innerText || n.textContent || '').toLowerCase();
        if(text.includes(q)){
          n.classList.add('highlight');
          let p = n.parentElement;
          while(p && p !== document.body){
            if(p.tagName.toLowerCase()==='ul') p.classList.remove('hidden');
            p = p.parentElement;
          }
        }
      });
    });

    document.getElementById('expandAll').addEventListener('click', ()=>{
      document.querySelectorAll('ul.org').forEach(u=>u.classList.remove('hidden'));
      document.querySelectorAll('.toggle').forEach(t=>{ if(t.textContent) t.textContent='â–¾' });
    });
    document.getElementById('collapseAll').addEventListener('click', ()=>{
      document.querySelectorAll('ul.org').forEach((u,i)=>{ if(i>0) u.classList.add('hidden') });
      document.querySelectorAll('.toggle').forEach(t=>{ if(t.textContent) t.textContent='â–¸' });
    });
  </script>
</body>
</html>
